version: '3.8'

services:
  manager:
    build:
      context: ..
      dockerfile: build/manager/Dockerfile
    volumes:
      - ../shared_volume:/app/shared_volume
    environment:
      NUM_ITERATIONS: 30
      NUM_HYPERPARAM_SETS: 10
      SEED: 42
      MODEL_CHOICE: xgb
    command: ["python3", "manager.py"]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [ gpu ]
              device_ids: [ "2" ]

  worker:
    build:
      context: ..
      dockerfile: build/worker/Dockerfile
    volumes:
      - ../shared_volume:/app/shared_volume
    environment:
      MODEL_CHOICE: xgb
      SEED: 42
    command: ["python3", "train.py"]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [ gpu ]
              device_ids: [ "2" ]

  test:
    image: nvidia/cuda:12.2.0-runtime-ubuntu22.04
    command: nvidia-smi
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [ gpu ]
              device_ids: [ "2" ]