version: '3.8'

services:
  manager:
    build:
      context: ..
      dockerfile: build/manager/Dockerfile
    volumes:
      - ../shared_volume:/app/shared_volume
    environment:
      NUM_ITERATIONS: 3
      NUM_HYPERPARAM_SETS: 5
      SEED: 42
      MODEL_CHOICE: xgb
    command: ["python3", "manager.py"]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [ gpu ]
              device_ids: [ "2" ]

  worker:
    build:
      context: ..
      dockerfile: build/worker/Dockerfile
    volumes:
      - ../shared_volume:/app/shared_volume
    environment:
      MODEL_CHOICE: xgb
      SEED: 42
    command: ["python3", "train.py"]
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [ gpu ]
              device_ids: [ "2" ]
      #mode: replicated
      #replicas: 3  # Default number of independent workers
    restart: always